# QueryIO Database Schema

This document describes the database schema for the QueryIO application. The schema is defined using Prisma and deployed to a PostgreSQL database in Supabase.

## Models

### User

The `User` model represents a registered user of the application.

```prisma
model User {
  id          String       @id @default(cuid())
  firebaseUid String       @unique
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  connections Connection[]

  @@map("users")
}
```

- `id`: A globally unique identifier generated using CUID
- `firebaseUid`: The user's Firebase authentication UID
- `createdAt`: Timestamp when the user record was created
- `updatedAt`: Timestamp when the user record was last updated
- `connections`: Relation to the user's database connections

### Connection

The `Connection` model represents a database connection configured by a user.

```prisma
model Connection {
  id           String       @id @default(cuid())
  userId       String       @map("user_id")
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  encryptedUrl String       @map("encrypted_url")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  threads      ChatThread[]

  @@index([userId])
  @@map("connections")
}
```

- `id`: A globally unique identifier generated using CUID
- `userId`: Foreign key referencing the User who owns this connection
- `user`: Relation to the User model
- `name`: A user-provided name for this connection
- `encryptedUrl`: The connection string, encrypted with AES for security
- `createdAt`: Timestamp when the connection was created
- `updatedAt`: Timestamp when the connection was last updated
- `threads`: Relation to the chat threads for this connection

### ChatThread

The `ChatThread` model represents a conversation thread associated with a specific database connection.

```prisma
model ChatThread {
  id           String        @id @default(cuid())
  connectionId String        @map("connection_id")
  connection   Connection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  messages     ChatMessage[]

  @@index([connectionId])
  @@map("chat_threads")
}
```

- `id`: A globally unique identifier generated using CUID
- `connectionId`: Foreign key referencing the Connection this thread belongs to
- `connection`: Relation to the Connection model
- `createdAt`: Timestamp when the thread was created
- `updatedAt`: Timestamp when the thread was last updated
- `messages`: Relation to the messages in this thread

### ChatMessage

The `ChatMessage` model represents an individual message within a chat thread.

```prisma
model ChatMessage {
  id        String     @id @default(cuid())
  threadId  String     @map("thread_id")
  thread    ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender    String     // "user" or "ai"
  content   String
  sql       String?    // optional, only for AI responses
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  @@index([threadId])
  @@map("chat_messages")
}
```

- `id`: A globally unique identifier generated using CUID
- `threadId`: Foreign key referencing the ChatThread this message belongs to
- `thread`: Relation to the ChatThread model
- `sender`: Indicates who sent the message ("user" or "ai")
- `content`: The content of the message
- `sql`: Optional SQL query generated by the AI (only present in AI responses)
- `createdAt`: Timestamp when the message was created
- `updatedAt`: Timestamp when the message was last updated

## Migration Information

- **Migration Name**: `init`
- **Created**: Manual creation due to development environment
- **SQL Location**: `prisma/migrations/init/migration.sql`

## Important Notes

1. **Cascading Deletes**: All relations use `onDelete: Cascade` to ensure that when a parent record is deleted, all dependent records are automatically removed. For example:
   - When a User is deleted, all their Connections are deleted
   - When a Connection is deleted, all its ChatThreads are deleted
   - When a ChatThread is deleted, all its ChatMessages are deleted

2. **Indexes**: Indexes are created on all foreign key fields to improve query performance.

3. **PostgreSQL Extensions**: The schema uses the `pgcrypto` extension for UUID generation.

4. **Security**: Connection strings are stored in encrypted form using AES. The encryption/decryption is handled in the application code using the `AES_ENCRYPTION_KEY` environment variable.

5. **ID Generation**: All models use CUID for ID generation, which provides globally unique identifiers that are more sortable and shorter than UUIDs.

## Testing Database Connectivity

A database connectivity test script is provided to verify that your database connection is working properly. To use it:

1. Ensure that your `.env.local` file contains the correct `SUPABASE_DATABASE_URL` value.
2. Run the test script using:
   ```bash
   npm run db:test
   ```
   or
   ```bash
   npx ts-node scripts/dbTest.ts
   ```

The script will:
- Check that the environment variables are set correctly
- Attempt to connect to the database
- Run a simple query to verify connectivity
- Check if the User table exists (verifying the migration was applied)
- Provide helpful error messages and troubleshooting tips if anything fails

This is especially useful when setting up a new development environment or when diagnosing connection issues. 